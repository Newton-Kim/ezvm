LIBRARY=libezvm.so.0.0.1
LINK_MAJOR=libezvm.so.0
LINK=libezvm.so
OBJS=vm.o \
	ezasm.o \
	ezarchive.o \
	ezval.o \
	ezinstruction.o \
	intrinsic/ezintrinsic.o \
	intrinsic/ezio.o \
	utility/ezfile.o \
	utility/ezlog.o

CXXFLAGS=-g -fPIC -O2 -std=gnu++11 -I../../include -I.

all: $(LIBRARY) $(LINK) $(LINK_MAJOR)

$(LINK) $(LINK_MAJOR):
	ln -s $(LIBRARY) $@

$(LIBRARY): $(OBJS)
	$(CXX) -shared -o $@ $^

local: ../../lib ../../lib/$(LIBRARY) ../../lib/$(LINK_MAJOR) ../../lib/$(LINK)
../../lib/$(LIBRARY): $(LIBRARY)
	cp $< $@
	
../../lib/$(LINK_MAJOR) ../../lib/$(LINK):
	ln -s $(LIBRARY) $@

../../lib:
	mkdir $@

install: $(INST_DIR)/lib $(INST_DIR)/lib/$(LIBRARY) $(INST_DIR)/lib/$(LINK_MAJOR) $(INST_DIR)/lib/$(LINK)

$(INST_DIR)/lib:
	install -d $@

$(INST_DIR)/lib/$(LIBRARY): $(LIBRARY)
	install -s $< $$(dirname "$@")

$(INST_DIR)/lib/$(LINK_MAJOR) $(INST_DIR)/lib/$(LINK):
	ln -s $(LIBRARY) $@

clean:
	rm -f $(LIBRARY) $(LINK_MAJOR) $(LINK) $(OBJS)

distclean: clean
	rm -f Makefile
